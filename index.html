<!DOCTYPE html>
<html lang="ch">

<head>
    <meta charset="utf-8" />
    <title>pixiv图片查询</title>
    <style>
        .input-container {
            display: flex;
            align-items: center;
        }

        .input-container input {
            margin-right: 5px;
        }

        #loading-text {
            display: none;
        }

        .btn {
            background-color: blue;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
        }

        .btn-clear {
            background-color: red;
        }
    </style>
</head>

<body>
    <p>在框内输入作品ID（如82775556）再按“查询”按钮即可查看对应作品</p>
    <hr />
    <div class="input-container">
        <input type="text" class="i" size="10" autofocus id="pid" placeholder="输入pid" required="required" />
        <span>-</span>
        <input type="text" class="i" size="3" id="number" value="" />
    </div>
    <button type="button" class="btn" onclick="prevImage()">上一张</button>
    <button type="button" class="btn" onclick="nextImage()">下一张</button>
    <button type="button" class="btn" onclick="checkInput()">查询</button>
    <button type="button" class="btn" onclick="downloadImage()">下载图片</button>
    <button type="button" class="btn" onclick="pasteClipboard()">粘贴</button>
    <button type="button" class="btn btn-clear" onclick="clearInput()">清空</button>
    <br />
    <hr />
    <span id="loading-text"></span>
    <img id="image" src="" width="500" alt="" style="display: none;" />
    <noscript>无法使用JavaScript</noscript>

    <script>
        let requestCounter = 0;

        function pasteClipboard() {
            navigator.clipboard.readText().then(text => {
                var pidInput = document.getElementById("pid");
                pidInput.value = text.replace(/\D/g, ''); // 仅保留数字
            }).catch(err => {
                console.error('Failed to read clipboard contents: ', err);
            });
        }

        function checkInput() {
            const currentRequest = ++requestCounter;
            var pid = document.getElementById("pid").value;
            var number = document.getElementById("number").value;
            var image = document.getElementById('image');
            var loadingText = document.getElementById('loading-text');

            // 取消之前的加载状态
            image.src = "";
            image.style.display = "none";

            var tryImage = function(type) {
                var imageUrl = "https://pixiv.re/" + pid;
                if (number !== "") {
                    imageUrl += "-" + number;
                }
                imageUrl += "." + type;

                loadingText.innerText = "正在请求 " + imageUrl;
                loadingText.style.display = "inline";

                var img = new Image();
                img.onload = function() {
                    if (requestCounter === currentRequest) {
                        image.src = imageUrl;
                        image.alt = "";
                        loadingText.style.display = "none";
                        image.style.display = "block";
                    }
                };
                img.onerror = function() {
                    if (requestCounter === currentRequest) {
                        if (type === "jpg") {
                            tryImage("png");
                        } else if (type === "png") {
                            tryImage("gif");
                        } else {
                            loadingText.style.display = "none";
                            image.alt = "图片不存在";
                            image.style.display = "block";
                        }
                    }
                };
                img.src = imageUrl;
            };

            tryImage("jpg");
        }

        function nextImage() {
            var numberInput = document.getElementById("number");
            var currentValue = numberInput.value.trim(); // Remove leading and trailing whitespace
            if (currentValue === "") {
                numberInput.value = "1";
            } else {
                var newValue = parseInt(currentValue) + 1;
                numberInput.value = newValue;
            }
            checkInput();
        }

        function prevImage() {
            var numberInput = document.getElementById("number");
            var currentValue = parseInt(numberInput.value.trim()); // Remove leading and trailing whitespace
            if (currentValue > 1) {
                numberInput.value = currentValue - 1;
            } else {
                numberInput.value = "";
            }
            checkInput();
        }

        function downloadImage() {
            var imageUrl = document.getElementById("image").src;

            if (!imageUrl || imageUrl === "" || imageUrl === "https://pixiv.re/" || imageUrl === "https://booksreaders1.github.io/" ) {
                alert("下载失败：图片不存在");
                return;
            }

            fetch(imageUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("下载失败：图片不存在");
                    }
                    return response.blob();
                })
                .then(blob => {
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'pixiv_image' + getImageExtension(imageUrl);
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    // For mobile devices, we attempt to use Filesystem API or prompt a save dialog
                    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                        if (navigator.share) {
                            navigator.share({
                                title: 'Pixiv Image',
                                text: 'Download the image',
                                url: imageUrl
                            }).catch(error => console.error('Error sharing', error));
                        }
                    }
                })
                .catch(error => {
                    alert(error.message);
                });
        }

        function getImageExtension(url) {
            var ext = url.split('.').pop();
            if (['jpg', 'png', 'gif'].includes(ext)) {
                return '.' + ext;
            }
            return '.jpg';
        }

        function clearInput() {
            document.getElementById("pid").value = "";
            document.getElementById("number").value = "";
            document.getElementById("image").src = "";
            document.getElementById("image").style.display = "none";
            document.getElementById('loading-text').style.display = "none";
        }
    </script>
</body>

</html>
